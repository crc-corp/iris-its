#!/usr/bin/env python

"""This simple script accepts a connection from protozoa, which should be
   sending PTZ packets in Pelco D protocol.  It then forwards them on to
   an Infinova IP camera."""

import socket

auth = ''.join(chr(c) for c in [
	0x49, 0x4e, 0x46, 0x01, 0x00, 0x01, 0x00, 0x01,	# header
	0x00, 0x00, 0x00, 0x40,				# packet length
	0x49, 0x4e, 0x46, 0x49, 0x4e, 0x4f, 0x56, 0x41,	# user name
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0xb0, 0xe7, 0xaa, 0x72, 0x11, 0x77, 0xd6, 0xf3,	# password ?
	0xf1, 0xa1, 0x0e, 0x7a, 0x1e, 0x96, 0x85, 0x7a,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00,					# mystery meat
])
header = ''.join(chr(c) for c in [
	0x49, 0x4e, 0x46, 0x13, 0x00, 0x00, 0x00, 0x00,	# header
	0x00, 0x00, 0x00, 0x13,				# packet length
	0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07,	# PTZ header
	0x00, 0x00, 0x00, 0x00,
])

# accept one socket connection from protozoa
protozoa = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
protozoa.bind(('', 8010))
protozoa.listen(10)
f, address = protozoa.accept()

# camera IP address and port
HOST = '151.111.8.105'
PORT = 90
camera = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
camera.connect((HOST, PORT))

# send auth message
camera.send(auth)

while True:
	# Read one Pelco D packet
	d = f.recv(7)
	# prepend header and send to camera
	camera.send(header + d)
